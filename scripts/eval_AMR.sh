#!/bin/bash
dir=$1 # the directory containing the AMR graphs that need to be relabeled and other files:
# All files required: parserOut.txt (unlabeled graphs), indices.txt (their indices in the original corpus),
# sentences.txt, pos.txt, labels.txt (best non-null labels per token), literal.txt, goldAMR.txt
# These files get generated by scripts/preprocess_AMR_test.sh and by de.saar.coli.amrtagging.formalisms.amr.tools.EvaluateCorpus.java (in am-tools)
# Also puts the output files in the same directory: relabeled.txt and gold_orderedAsRelabeled.txt
ALTO_PATH=$(readlink -f "$2")

# if these files are missing, run scripts/setup_AMR.sh
lookup="downloaded_models/lookup/lookupdata17/"
wordnet_path="downloaded_models/wordnet3.0/dict/"

echo "relabelling with threshold 10"

# run the relabeller
java -Xmx2G -cp "$ALTO_PATH" de.saar.coli.amrtagging.formalisms.amr.tools.Relabel $dir/ "$lookup" "$wordnet_path" 10

echo "final post-processing"

# now we have a relabelled.txt in this directory
# do more post-processing
sed -E 's/\(u_[0-9]+ \/ ([-+0-9]+)\)/\1/g' $dir/relabeled.txt | sed -E 's/\(explicitanon[0-9]+ \/ ([^"()]+)\)/"\1"/g' | sed -E 's/\(explicitanon[0-9]+ \/ ("[^"]+")\)/\1/g' | sed -E 's/"([-+0-9]+)"/\1/g' > $dir/relabeled_fixed.txt

# compute smatch score
echo "smatching in $dir"

python2 external_eval_tools/smatch/smatch.py -f $dir/relabeled_fixed.txt $dir/gold_orderedAsRelabeled.txt --significant 4 --pr | tee $dir/smatch.txt
